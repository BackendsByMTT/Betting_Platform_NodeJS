<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Odds</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f0f2f5;
        color: #333;
        margin: 0;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
        letter-spacing: -1px;
      }

      #odds {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
      }

      .odds-card {
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 20px;
        width: 100%;
        max-width: 300px;
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
      }

      .odds-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }

      .odds-card h3 {
        font-size: 1.5em;
        color: #0066cc;
        margin: 0 0 10px;
      }

      .odds-card p {
        font-size: 1em;
        color: #555;
        margin: 10px 0;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        padding-top: 60px;
      }

      .modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 400px;
        border-radius: 12px;
        text-align: center;
      }

      .modal-content h2 {
        margin: 0 0 20px;
      }

      .modal-content select {
        width: 80%;
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1em;
      }

      .modal-content input {
        width: 80%;
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }

      .modal-content button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        background-color: #0066cc;
        color: white;
        font-size: 1em;
        cursor: pointer;
        margin: 10px;
        transition: background-color 0.3s ease;
      }

      .modal-content button:hover {
        background-color: #005bb5;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1 id="event-title">Event Odds</h1>
    <div id="odds"></div>

    <!-- The Modal -->
    <div id="betModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Place Your Bet</h2>
        <p id="bet-details"></p>
        <select id="team-selection"></select>
        <input type="number" id="bet-amount" placeholder="Enter bet amount" />
        <button id="confirm-bet">Confirm Bet</button>
        <button id="cancel-bet">Cancel</button>
      </div>
    </div>

    <script>
      const socket = io("http://localhost:5000", {
        auth: {
          token:
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NmJjN2U0MmUzYjQ5NmFlMzQxNjA3Y2MiLCJ1c2VybmFtZSI6ImFudXNoYWthIiwicm9sZSI6InBsYXllciIsImNyZWRpdHMiOjAsImlhdCI6MTcyMzc4NDE5NiwiZXhwIjoxNzIzODcwNTk2fQ.U_2i1GHb2qV1Pxdam2CFlZGqZBJ9M_5rebLDpFQrjAo", // Replace with your actual JWT token
        },
      });

      const urlParams = new URLSearchParams(window.location.search);
      const sport = urlParams.get("sport");
      const eventId = urlParams.get("eventId");
      const regions = urlParams.get("regions");
      const markets = urlParams.get("markets");
      const dateFormat = urlParams.get("dateFormat");
      const oddsFormat = urlParams.get("oddsFormat");

      document.getElementById(
        "event-title"
      ).textContent = `Odds for Event: ${eventId}`;

      socket.on("connect", () => {
        socket.emit("data", {
          action: "EVENT_ODDS",
          payload: {
            sport: sport,
            eventId: eventId,
            regions: regions,
            markets: markets,
            dateFormat: dateFormat,
            oddsFormat: oddsFormat,
          },
        });
      });

      socket.on("error", (message) => {
        console.error(message);
      });

      socket.on("data", (res) => {
        if (res.type === "EVENT_ODDS" && res.data) {
          console.log(res);
          renderOdds(res.data);
        } else {
          renderNoOddsMessage();
        }
      });

      socket.on("error", (err) => {
        alert("An error occurred while communicating with the server.");
      });

      socket.on("disconnect", () => {
        alert("Disconnected from the server. Please check your connection.");
      });

      function renderOdds(data) {
        console.log("D : ", data);
        const oddsContainer = document.getElementById("odds");
        oddsContainer.innerHTML = "";

        data.bookmakers.forEach((bookmaker) => {
          const oddsCard = document.createElement("div");
          oddsCard.className = "odds-card";

          const bookmakerTitle = document.createElement("h3");
          bookmakerTitle.textContent = bookmaker.title;
          oddsCard.appendChild(bookmakerTitle);

          const homeTeamOdds = bookmaker.markets
            .find((market) => market.key === "h2h")
            .outcomes.find((outcome) => outcome.name === data.home_team);
          const awayTeamOdds = bookmaker.markets
            .find((market) => market.key === "h2h")
            .outcomes.find((outcome) => outcome.name === data.away_team);

          const homeTeamDetail = document.createElement("p");
          homeTeamDetail.textContent = `${data.home_team}: ${homeTeamOdds.price}`;
          oddsCard.appendChild(homeTeamDetail);

          const awayTeamDetail = document.createElement("p");
          awayTeamDetail.textContent = `${data.away_team}: ${awayTeamOdds.price}`;
          oddsCard.appendChild(awayTeamDetail);

          oddsCard.addEventListener("click", () => {
            showModal(data, bookmaker, homeTeamOdds, awayTeamOdds);
          });

          oddsContainer.appendChild(oddsCard);
        });
      }

      function showModal(eventData, bookmaker, homeTeamOdds, awayTeamOdds) {
        const modal = document.getElementById("betModal");
        const teamSelection = document.getElementById("team-selection");
        const betDetails = document.getElementById("bet-details");
        const betAmountInput = document.getElementById("bet-amount");

        teamSelection.innerHTML = `
          <option value="home_team">${eventData.home_team} at ${homeTeamOdds.price}</option>
          <option value="away_team">${eventData.away_team} at ${awayTeamOdds.price}</option>
        `;

        betDetails.textContent = `Bet on a team for the match between ${eventData.home_team} and ${eventData.away_team}.`;
        betAmountInput.value = "";
        modal.style.display = "block";

        let confirmBetButton = document.getElementById("confirm-bet");

        // Clone the button to remove any previous event listeners
        const newConfirmBetButton = confirmBetButton.cloneNode(true);
        confirmBetButton.replaceWith(newConfirmBetButton);

        // Now attach the event listener to the new button
        newConfirmBetButton.addEventListener("click", () => {
          const selectedTeam = teamSelection.value;
          const betAmount = betAmountInput.value;

          console.log("CLICK");

          if (betAmount > 0) {
            const selectedOdds =
              selectedTeam === "home_team"
                ? homeTeamOdds.price
                : awayTeamOdds.price;
            const betOn =
              selectedTeam === "home_team"
                ? eventData.home_team
                : eventData.away_team;

            const betData = {
              player: "66bc7e42e3b496ae341607cc", // Replace with actual player ID
              sport_title: eventData.sport_title,
              event_id: eventId,
              commence_time: eventData.commence_time,
              home_team: {
                name: eventData.home_team,
                odds: homeTeamOdds.price,
              },
              away_team: {
                name: eventData.away_team,
                odds: awayTeamOdds.price,
              },
              market: "h2h", // Assuming h2h market
              bet_on: selectedTeam,
              amount: betAmount,
              status: "pending",

              sport: sport, // Assuming sport_title corresponds to the sport
              oddsFormat: oddsFormat,
            };

            console.log("BET : ", betData);

            if (socket.connected) {
              console.log("BET SOCKET: ", socket.connected);
              socket.emit(
                "bet",
                { action: "PLACE", payload: betData },
                (response) => {
                  if (response.status === "success") {
                    alert(
                      `Bet placed: ${betAmount} on ${betOn} at odds of ${selectedOdds} with ${bookmaker.title}`
                    );
                    modal.style.display = "none";
                  } else {
                    alert("Bet failed to send. Please try again.");
                  }
                }
              );
              console.log("BET PLACE SOCKET: ", socket.connected);
            } else {
              alert("Socket connection lost. Please try again.");
            }
          } else {
            alert("Please enter a valid bet amount.");
          }
        });

        document.getElementById("cancel-bet").onclick = function () {
          modal.style.display = "none";
        };
      }

      function renderNoOddsMessage() {
        const oddsContainer = document.getElementById("odds");
        oddsContainer.innerHTML = "";

        const noOddsMessage = document.createElement("p");
        noOddsMessage.className = "no-odds";
        noOddsMessage.textContent = "No odds available for this event.";
        oddsContainer.appendChild(noOddsMessage);
      }

      document.querySelector(".close").onclick = function () {
        document.getElementById("betModal").style.display = "none";
      };

      window.onclick = function (event) {
        const modal = document.getElementById("betModal");
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };
    </script>
  </body>
</html>
