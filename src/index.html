<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket.IO Test</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  </head>
  <body>
    <h1>Socket.IO Test</h1>
    <button id="disconnectBtn">Disconnect</button>
    <button id="sendBetBtn">Send Bet</button>
    <button id="sendBetStart">Start Process</button>

    <h2>Sports</h2>
    <div id="sports"></div>

    <h2>Events</h2>
    <div id="events"></div>

    <script>
      const socket = io("http://localhost:5000", {
        auth: {
          token:
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NmIzNTczY2I4YTYyYmNmMzlhODdmNDYiLCJ1c2VybmFtZSI6InBsYXllciIsInJvbGUiOiJwbGF5ZXIiLCJpYXQiOjE3MjMyMDM5MDksImV4cCI6MTcyMzI5MDMwOX0.Fc1OPR1L7P1L3rDv3ZN2z4DPvd0RRxN1uhdcvkbG42w",
        },
      });

      socket.on("connect", () => {
        socket.emit("data", { action: "INIT" });
        console.log("Connected to server");
      });

      socket.on("message", (data) => {
        console.log(data);
        if (Array.isArray(data)) {
          if (data.length > 0 && data[0].sport_key) {
            renderEvents(data); // Render event data
          } else if (data.length > 0 && data[0].key) {
            renderSports(data); // Render sports data
          }
        } else {
          console.log("Data received:", data);
        }
      });

      socket.on("error", (err) => {
        console.error("Socket Error:", err);
      });

      socket.on("disconnect", () => {
        console.log("Disconnected from server");
      });

      function renderSports(sports) {
        const sportsContainer = document.getElementById("sports");
        sportsContainer.innerHTML = ""; // Clear the container before rendering

        const table = document.createElement("table");
        table.setAttribute("border", "1");

        // Create table header
        const headerRow = document.createElement("tr");
        const headers = [
          "Key",
          "Active",
          "Group",
          "Description",
          "Title",
          "Has Outrights",
        ];
        headers.forEach((header) => {
          const th = document.createElement("th");
          th.textContent = header;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        // Populate table with sports data
        sports.forEach((sport) => {
          const row = document.createElement("tr");

          const keyCell = document.createElement("td");
          keyCell.textContent = sport.key;
          row.appendChild(keyCell);

          const activeCell = document.createElement("td");
          activeCell.textContent = sport.active ? "Yes" : "No";
          row.appendChild(activeCell);

          const groupCell = document.createElement("td");
          groupCell.textContent = sport.group;
          row.appendChild(groupCell);

          const descriptionCell = document.createElement("td");
          descriptionCell.textContent = sport.description;
          row.appendChild(descriptionCell);

          const titleCell = document.createElement("td");
          titleCell.textContent = sport.title;
          row.appendChild(titleCell);

          const hasOutrightsCell = document.createElement("td");
          hasOutrightsCell.textContent = sport.has_outrights ? "Yes" : "No";
          row.appendChild(hasOutrightsCell);

          // Add click event listener to the row to request events for this sport
          row.addEventListener("click", () => {
            socket.emit("data", { action: "EVENT", payload: sport.key });
            console.log(`Requested events for sport key: ${sport.key}`);
          });

          table.appendChild(row);
        });

        sportsContainer.appendChild(table);
      }

      function renderEvents(events) {
        const eventsContainer = document.getElementById("events");
        eventsContainer.innerHTML = ""; // Clear the container before rendering

        const table = document.createElement("table");
        table.setAttribute("border", "1");

        // Create table header
        const headerRow = document.createElement("tr");
        const headers = [
          "ID",
          "Sport Key",
          "Sport Title",
          "Commence Time",
          "Home Team",
          "Away Team",
        ];
        headers.forEach((header) => {
          const th = document.createElement("th");
          th.textContent = header;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        // Populate table with event data
        events.forEach((event) => {
          const row = document.createElement("tr");

          const idCell = document.createElement("td");
          idCell.textContent = event.id;
          row.appendChild(idCell);

          const sportKeyCell = document.createElement("td");
          sportKeyCell.textContent = event.sport_key;
          row.appendChild(sportKeyCell);

          const sportTitleCell = document.createElement("td");
          sportTitleCell.textContent = event.sport_title;
          row.appendChild(sportTitleCell);

          const commenceTimeCell = document.createElement("td");
          commenceTimeCell.textContent = new Date(
            event.commence_time
          ).toLocaleString();
          row.appendChild(commenceTimeCell);

          const homeTeamCell = document.createElement("td");
          homeTeamCell.textContent = event.home_team;
          row.appendChild(homeTeamCell);

          const awayTeamCell = document.createElement("td");
          awayTeamCell.textContent = event.away_team;
          row.appendChild(awayTeamCell);

          table.appendChild(row);
        });

        eventsContainer.appendChild(table);
      }
    </script>
  </body>
</html>
